# Описание работы Telegram-бота для обработки меню (v2)

Этот документ описывает актуальный цикл работы Telegram-бота, который преобразует фотографию меню в интерактивную HTML-страницу.

## Общий процесс

Процесс был оптимизирован для уменьшения количества запросов к AI и улучшения качества изображений.

1.  **Получение изображения:** Пользователь отправляет фото меню. `handlers.py` принимает его, скачивает во временную папку и генерирует для будущего файла читаемое имя (`menu_ГГГГММДД_ЧЧММСС.html`).

2.  **Распознавание текста (OCR):** `ocr.py` извлекает весь текст с изображения и возвращает его в виде единой строки.

3.  **Анализ меню (1 AI-запрос):** `menu_processor.py` отправляет весь текст **одним запросом** в языковую модель (например, `gemini-1.5-flash`). Модель получает инструкцию извлечь все блюда и для каждого сформировать JSON-объект с полями: `translatedName`, `price`, `shortDescription`, `ingredients`, `containsGluten`, `containsMilk` и, что важно, `imageSearchQuery`.
    *   `imageSearchQuery` — это специально сгенерированный, краткий и точный поисковый запрос на английском языке, предназначенный для поиска изображений на фотостоках.

4.  **Поиск изображений (N запросов к Pexels API):** `handlers.py` итерируется по списку полученных блюд. Для каждого блюда он вызывает `image_generator.py`, который:
    *   Берет значение из поля `imageSearchQuery`.
    *   Делает запрос к API сервиса **Pexels**.
    *   Получает и возвращает URL наиболее подходящего изображения.

5.  **Генерация HTML-страницы:** `handlers.py` передает финальный список блюд (уже с URL-ами картинок) в `html_generator.py`. Этот модуль формирует готовую HTML-страницу с карточками блюд, их описаниями, ценами и изображениями.

6.  **Отправка результата:** Бот отправляет пользователю сгенерированный HTML-файл с читаемым именем.

## Количество запросов к внешним сервисам

Общее количество запросов для обработки одного меню теперь рассчитывается по формуле:

**`1 (запрос к AI для анализа текста) + N (запросов к Pexels API для поиска картинок)`**

Где **N** — количество блюд в меню.

Это значительно эффективнее предыдущей модели, так как дорогостоящий запрос к AI выполняется всего один раз.

### Пример объекта блюда (после шага 3)

После анализа текста модель возвращает массив объектов. Вот как выглядит один из них (до поиска изображения):

```json
{
    "originalName": "Steak Frites",
    "translatedName": "Стейк с картофелем фри",
    "image": "placeholder",
    "imageSearchQuery": "juicy grilled steak with golden french fries on a plate, restaurant food photography",
    "category": "Основные блюда",
    "price": "25€",
    "shortDescription": "Сочный стейк, приготовленный на гриле до желаемой степени прожарки, подается с порцией хрустящего золотистого картофеля фри.",
    "ingredients": ["говядина", "картофель", "специи", "масло"],
    "containsGluten": "no",
    "containsMilk": "no"
}
```